Remote Observing
****************

Introduction
============

Remote observing with the Parkes telescope from the Marsfield Science Operations Centre (SOC) which commenced in December 2012, and is expected 
to be the default mode of observing by the start of the OCT13 semester. Observing from Parkes will still be permitted for complex or non-standard 
observations, or in other circumstances where this is the more sensible option. Observers who have successfully observed from the SOC will be 
permitted to carry out subsequent Parkes observations from other remote locations: all observers must observe at least once every 12  months from 
the SOC in order to become a qualified Parkes remote observer. An introduction to the SOC is available `here <http://www.atnf.csiro.au/observers/SOC/>`_.

Before You Observe
==================

Remote observing requirements
-----------------------------

The remote observer will need the following:

* An active CSIRO login account. To establish an account, follow the instructions `here <http://www.atnf.csiro.au/cgi-bin/atnfres/ident_request.pl>`_. 
  Allow 5 working days for the account to be established.

* To book as an observer for the scheduled observations using the `Observer PORTAL <https://parkes-ops.atnf.csiro.au/PORTAL/index.php>`_,
  under the “Book” tab; see below for an example on how to perform project bookings.

* To have completed the online Observing induction and have observed from the SOC (or Parkes)
  in the last twelve months. First-time observers will need to conduct a face-to-face
  induction at the SOC in Sydney under the supervision 
  of a trainer before being qualified as Remote Observer.

* To have a project requiring a standard configuration. If the observation is non-standard, the 
  observer is required to come to the SOC or Parkes at least for the first run of the project 
  to support the non-standard setup (if required) and/or be trained in the use of the special 
  observing setup the project requires.

* A computer with the following: 
 * Access to the internet; 
 * A recent version of a commonly used operating system. 
 * A version of VNC viewer, TightVNC (Windows) or Chicken of the VNC (MacOS X).
 * A web browser that supports HTML5 and has javascript enabled; supported browsers are: Firefox v16+, Sarafi v6+ and 
   Chrome v23+. Internet Explorer v8+.
 * A screen size at least 1920 x 1200 is recommended; a multiple screen setup will be beneficial for more complex observing 
   setups for observing from places other than the SOC (i.e., where two instances of TCS are required).

How to book for observing projects
----------------------------------

Booking for projects is vital as Science Operations needs to ensure all observers are fully qualified. In terms of qualification,
this means you have observed from the SOC (or Parkes) at least once, have completed the online Observer induction
in the last twelve months and in the case of first-time observers, undertake a face-to-face induction to familiarise yourself
with how observing with Parkes is undertaken (this can be done at the SOC or remotely if appropriate.)

You can determine your eligibility to remote observe by looking at the "Your certification status" under the "Certification" tab of
the PORTAL.

Please note we require all bookings to be made at least two weeks prior to the scheduled observations.

If there are no bookings 14 days prior to schedule observations, an email is sent to the project Principal Investigator, asking them 
to start organising people to book on the PORTAL. Another reminder is sent to all people on the proposal 7 days out. 
Once you have obtained a CASS Unix account, you can log onto the `Observing PORTAL <https://parkes-ops.atnf.csiro.au/PORTAL/index.php>`_.

An example of booking for an observation is shown below.

* Log onto the PORTAL and click on the "Book" tab. The interface should look like that below.

* Click on "Booking details" and enter your details on the left-hand side. This includes information such as your location and any other details
  relevant to the booking in the Comments section. If you are observing for a NAPA or ToO observation,

* To request Green Time, you can double-click on 'Green Time' and enter a project code if known or enter 'PX' if a new observation.
 
* You can filter against specific projects using the "Select Project" dropdown on the right-hand side.
  Select your project and click on "showFilter". In the example below, future blocks for project P486 are shown. Click on "reloadSched"
  to display all projects. Clicking on the project code in this table will change the calendar view to that starting date.

* Once you have your selected project(s), you will see a "Book" button next to observing blocks. To place your name against any
  block, click on "Book". The PORTAL will process the request and if everything is okay (i.e., you have all relevant details filled out),
  the button will change from "Book" to "Cancel" (see image below.) At this stage booking for the first P486 block is complete and
  you can make subsequent bookings as required. If you navigate to the relevant schedule calendar block(s), your name will be listed.
  Each schedule block in the calendar will show who is observing- those observing from the SOC are indicated in white.

* If you make a mistake- say book against the wrong project, you simply click the "Cancel" button for that observing block.
  Your name will also be removed from the Schedule calendar block.

Remote Observing Support
------------------------

The remote observer in need of assistance should, in general, consult these in the order given below.

* The Online User Guide (this document).

* The designated Project Expert. This is equivalent to the DA role at Narrabri, but specific to the project. 
  This is usually an expert observer of the Parkes Telescope.

* During business hours only, a rostered member of the Parkes SO staff can contacted if the issue is beyond 
  the knowledge of the Project Expert.

* The Emergency Contact Person can be contacted for emergencies only, out of business hours. They are not to 
  be contacted for issues relating to observing unless they pose a threat to the antenna safety.
 
FIXME shows the flow of support as defined above.

Role of the Remote Observer
--------------------------

The role of the Remote Observer is to monitor the progress of the observation and the condition of the telescope and 
collected data through a variety of interfaces. During the observation, this monitoring is the remote observers' primary 
responsibility.

The state of the telescope is monitored by its automated protection system, the TPS (Telescope Protection System). The 
TPS monitors the critical telescope systems, and acts in favour of the safety of the telescope if adverse conditions are 
detected. Its actions include stowing the telescope or disabling its motion, switching between alternate power sources 
for the telescope and initiating observatory staff intervention. Monitoring displays used for observing will inform the 
observer of any action taken by the TPS.

Role of the Project Expert
--------------------------

Each team is required to nominate the Project Expert at the time of the proposal submission. This is an astronomer who 
is an expert observer of the Parkes Telescope for that specific observing mode. Tasks of the Expert are:

* To train the Observer to Remote Observations in case of First Time Observers or  Observers who have not conducted 
  observations with Parkes in the last 12 months. This usually happens either at Parkes or at the SOC and includes training on:

  * Setting up schedules 
  * Setting up the observations
  * Startup observations
  * Assessing the data quality 

* Support the team observations. The Expert will set the time range he/she can be contacted. 

* To contact Science Operations support in case of need (business hours only, 8:00-16:00 weekdays only).

* Call the ECP for any perceived threats to telescope safety at any time.

Role of Science Operations
--------------------------

* Construct and publish the Parkes observing schedule and Online User Guides.
*  Manually override the handover mechanism when needed.
*  Train Project Experts.
*  Be part of the ECP team.
*  Call the ECP for any percieved threats to telescope safety at any time.

Emergency Call-out Person
-------------------------

The Emergency Call-out Person (ECP) is part of the Parkes Rapid Response Team which comprises members of the Parkes staff equipped to 
solve or assist in solving telescope safety issues that TPS cannot address. At all times one member of the team will be on duty. 
They will be contactable by the TPS, by staff in EO or SO, and by the remote observer. The role of the Call-out person is two-fold. 
The chief role is to assess any emergency situation brought to their attention, and if necessary call for assistance from other members 
of the team or from emergency services (eg. local fire brigade). The sequence to be followed is:

*  Acknowledge TPS call.
*  Assess the nature of the Alarm on the TPS (and other sources of information like the VNC sessions).
*  Take action on the TPS panel, if appropriate.
*  If necessary, travel to the telescope, and if safe, enter the tower.
*  Assess the situation to establish the source of the alarm and any other factors that have bearing on the situation (if not done in item 2 above); 
*  If necessary and safe, take control of the telescope.
*  Either act to remove or mitigate the threat, or call for extra assistance.
*  Log the response in the Call-out log.
*  Advise the observer on the likely course of action to return to normal operations. 
*  Once the situation is resolved (possibly hours later), return the TPS to its normal operating condition (various inputs may have been 
   isolated as part of the response) and  hand the telescope back to the remote observer.
*  Make a final log entry to close the event.

Stowing and Unstowing
---------------------

If you are unstowing the telescope for observing, you must follow the following procedures:

* Login in and check the chat utility is available on the Observing PORTAL.
* Check that the Telescope State is set to “OBSERVING” (on the chat utility.)
* Establish a dialogue with the current contact via phone call from details provided on the chat utility via the Observing PORTAL.
* Once permission to observe is obtained and the antenna is handed over to you, you need to register as the observer in charge via the Observing PORTAL.
* Follow the appropriate handover procedure as outlined below.

With the MCP in Computer Remote, you can stow/unstow the antenna using TCS. Under the "ACTION PANEL"
(top right of TCS GUI), you press the "Stow" button. Once complete, this will disable the drives in Azimuth
and for Zenith, the antenna will drive to the Zenith Stop position (~ -0.54 deg) and put in the locking pin.

.. warning:: 
   The safety timer will also be disabled.

To unstow the antenna, press the "Unstow-ExLim" button on TCS, under the "ACTION PANEL" section,
top right on the TCS GUI. This will remove the Zenith locking pin, drive the antenna out of limits
and leave both drives enabled. Note again, that the MCP must also be in Computer Remote.

.. warning:: 
   You can only start observing with TCS if the antenna is enabled and the Zenith angle is greater than 1.2 degrees.

Handover Procedures
-------------------

This section provides detailed checklists of the handover procedures for the different type of situations that can be met:

*  Staff-to-Observer
*  Observer-to-Staff
*  Observer-to-Observer
*  No Operator-to-Observer (start with antenna stowed)
*  Observer-to-No Operator (end with antenna stowed)
*  No Operator-to-Staff
*  Staff-to-No Operator

An example of “No Operator” is when the an Observer takes control after a Green Time period.
Here, ``Staff'' refers to Science and/or Engineering Operations staff, located at the Parkes site.

The above that are relevant to observing are described below, but users should consult the full procedures for
`remote operations: <http://www.parkes.atnf.csiro.au/observing/documentation/user_guide/RAPT_procedures_v2.3.pdf>`_.

Staff-to-Observer
^^^^^^^^^^^^^^^^^

*  Staff safely sets MCP to “Remote”;
*  Staff sets the antenna state to “OBSERVING” on the Observing PORTAL;
*  Staff makes the VNC sessions accessible from outside (e.g.: changing back the password to that known by the users);
*  Staff and Observer communicate via chat/phone and agree on handing over the antenna (N.B.: it is recommended this 
   occurs via telephone for the initial period of remote operations);
*  The Observer places their contact details on the Observing PORTAL;
*  The Observer takes control of the antenna by logging onto the VNC sessions; 
*  Observer sets up the observations (see User Guide for details); 
*  Observer conducts the observations.

Observer-to-Staff 
^^^^^^^^^^^^^^^^^

*  Staff contacts the current Observer via phone or chat utility – (N.B.: it is recommended this occurs via telephone for the 
   initial period of remote operations); 
*  Staff and Observer agree on when to hand over the antenna; 
*  Staff takes control of the antenna; 
*  Staff makes the VNC sessions unavailable to observers (e.g., killing the VNC sessions and changing the password);
*  Staff sets the antenna state to “MAINTENANCE” on the Observing PORTAL;
*  Staff operates the antenna for local activity (either Maintenance or Reconfiguration);

Observer-to-Observer
^^^^^^^^^^^^^^^^^^^^

*  The new Observer contacts the current Observer; 
*  The two Observers agree on handing over the antenna (time, how to leave the antenna, et cet.); 
*  Once the above is done, the new Observer registers themselves as the observer in charge via the Observing PORTAL;
*  N.B.: if the current observer is not contactable, the new Observer can take control of the antenna at the start of the project scheduled time; 
*  The new Observer takes control of the antenna;
*  Observer sets up the observations (see User Guide for details);
*  Observer conducts the observations.

No Operator-to-Observer 
^^^^^^^^^^^^^^^^^^^^^^^^

(N.B.: to further investigate whether this procedure - combined with the others, e.g. Staff-to-No Operator - is sufficiently safe.)

*  The new Observer checks that: 
        *  No one is in charge of the antenna (no details on the chat utility). 
        *  MCP is set to “Remote” 
        *  The antenna state on the Observing PORTAL is set to “OBSERVING”;
        *  The antenna is either stowed or stationary.
*  The Observer registers themselves as the observer in charge via the Observing PORTAL.
*  The Observer takes control of the antenna; 
*  Observer sets up the observations (see User Guide for details); 
*  Observer conducts the observations.

Observer-to-No Operator
^^^^^^^^^^^^^^^^^^^^^^^

*  The Observer ends the observations.
*  The Observer checks not having been contacted on the chat utility.
*  The Observer Stow the antenna (via TCS, see User Guide).
*  The Observer quits TCS and the Backend GUIs used. 
*  The Observer clears the contact details in the chat utility. 
*  The Observer quits the VNC sessions.

No Operator-to-Staff	
^^^^^^^^^^^^^^^^^^^^^^^^

* Staff check:
        *  No one is in charge of the antenna (no details on the chat utility)
        *  MCP is set to “Remote”
        *  The antenna state is set to “OBSERVING”;
        *  The antenna is either stowed or stationary.
* Staff take control of the antenna by;
        *  Staff makes the VNC session not available to the users (e.g., killing the VNC sessions and changing the password); 
        *  Staff sets the antenna state to “Maintenance”; 
        *  Staff operates the antenna for local activity (either Maintenance or Reconfiguration);

Staff-to-No Operator
^^^^^^^^^^^^^^^^^^^^

*  Staff safely sets MCP to “Remote”; 
*  Staff sets the antenna state to “Observing”; 
*  Staff makes the VNC sessions accessible from outside (e.g.: changing back the password to that known by the users);
*  Staff stows the antenna, leaves it under remote control, and leaves a message on the chat utility that the antenna is ready for remote observing; 
*  Staff clears the contact details in the chat utility. 
*  Staff quits the VNC client used.


Using VNC from the SOC 
-----------------------

Parkes Observing from the Science Operations Center (SOC) is done in a dedicated room with three monitors connected to the machine ``pyxis``. 
The username and password can be obtained from SOC observing support. The recommended layout for observing is shown below in FIXME. Please try to 
stick with this layout.

FIXME

The VNC servers on joffrey are run as user ``pksobs``. Prior to observing, ensure:

*  Have logged into the Parkes Observing Portal and FROG.
*  You have contacted the current observing team (or local Parkes staff member) that is listed on the PORTAL chat page.
*  On the Welcome tab of the Portal, click on the regitration of current observer/staff and enter your details.

Once the above is done, open two terminals, one in each screen on the SOC Parkes observing machine (``pyxis``) and  type: ::

 vncviewer joffrey.atnf.csiro.au:1 

in the first screen, then in the second, type ::
 
  vncviewer joffrey.atnf.csiro.au:2

.. tip::
   The current VNC password can be obtained from `here < http://www.atnf.csiro.au/observers/passwords/>`_.

The third screen should be used to dislay the following:

* Observing PORTAL: https://parkes-ops.atnf.csiro.au/PORTAL/index.php
* FROG: https://parkes-ops.atnf.csiro.au/FROG/index.php
* Pulsar Online Monitor: http://www.parkes.atnf.csiro.au/online/psrmon/

Other Pulsar backends:

*  APSR: http://apsr-srv0.atnf.csiro.au/apsr/
*  BPSR: http://hipsr-srv0.atnf.csiro.au/bpsr/
*  CASPSR: http://caspsr-srv0.atnf.csiro.au/caspsr/

As you will require a web brower to access the above, we recommend you do the following as the browser on joffrey and myrcella is disabled: ::

 ssh -L 30000:hipsr-srv0:80 ident@orion.atnf.csiro.au

Where ident is your ATNF *nix account which can be obtained from a link on the login page of the PORTAL. Once you have connected as above, you 
point your browser to: ::

 http://localhost:30000/apsr/ , http://localhost:30000/bpsr/ or http://localhost:30000/caspsr/

VNC startup on joffrey:1
------------------------

Assuming you are starting up for the first time, ensure the following are present on ``joffrey:1``.

TCS primary
-----------

On ``joffrey:1``, in the first virtual window. If TCS is already running, it is recommended you close it and exit the terminal (especially if 
interleaving projects are pulsar and spectral/continuum in nature.) Open a terminal on joffery and type: ::

 tcs

From the startup GUI, select the relevant mode for your observations (and select the expert mode). Select the relevant recall state if there is one. 
For example:

*  For DFB4 spectral--line/continuum observing select:
 *  DIGITAL F'BANK (time binning)
 *  EXPERT MODE
 *  SELECT PROJECT (if present, via bottom menu)
*  For Pulsar observing select:
 *  Pulsar observing modes.
 *  EXPERT MODE
 *  SELECT PROJECT (if present, via bottom menu).
 *  Once open:
  *  Select PDFB4.
  *  FOLD or SEARCH MODE
  *  SELECT relevant schedule
*  Focus: Enable
*  Antenna: Enable

If the antenna doesn't enable, likely it means that either another TCS is still running with antenna enabled (which takes the antenna control) or 
other software is controlling the antenna.

* Auxillary: Enable
* Correlator: Enable
* Sched agent: CTRL for Spectral-line/Continuum and GUI for Pulsar
* Sched files (Spectral--line/Continuum observations).
 * Click on Sched file and select OWN, then select the schedule file.
 * For Spectral-line and Continuum projects, schedule files are located in /home/pksobs/Projects/PXXX/ or /nfs/online/local/tcs/sched/pXXX .
 * For Pulsar projects, schedule files are usually located in /psr1/tcs/sched/ .

The indication that this is TCS primary is shown on the title bar of the TCS GUI.

TCS alternative
---------------

On ``joffrey:1``, in the second virtual window. If you are using another instance of TCS (i.e., you are using DFB3/DFB4 simultaneously), 
open a ``myrcella`` terminal (right--most terminal icon on taskbar) and type: ::

  start_alt
  tcs alt

If you are NOT using another instance of TCS, you may use this virtual window for other purposes, but note anything you open may be closed at the 
start of the next observing session. The indication that this is TCS alt is shown on the title bar of the TCS GUI. It is important to note that 
if TCS primary is running DFB3, then the alternative TCS must use DFB4. The same DFB cannot be used by both TCS's. It is important to note the 
dummy antenna systems are started by start_alt, otherwise file header parameters will be incorrect.

.. tip::
   Note that start_alt kills existing processes before restarting them. 
   For Pulsar projects, schedules such as the following should be used: P456_MB_PDFB4A.sch (note the ``A`` for alternate.)

LOBOSS, LOGUI and OPERFCC
-------------------------

On ``joffrey:1``, in the third virtual window. On the bottom panel, click on "Observing Tools" and start LOBOSS, OPERFCC and LOGUI.

PKMC
----

On ``joffrey:1``, in the fourth virtual window. On the bottom panel, click on "Observing Tools" and start PKMC.

VNC startup on joffrey:2
------------------------

Assuming you are starting up for the first time, ensure the following are present on ``joffrey:2``.

DFB4
----

On ``joffrey:2``, in the first virtual window.

If using DFB4, on the bottom panel, click on ``Backend Tools'' (twice) to open two ssh connections to pkccc4. In the first, type ::

  corkill 
  spd

Now, in the second terminal, type ::

  sdfb4 

for continuum/spectral-line projects, or for Pulsar observations, type ::

  pdfb4

MoniCA
------

On ``joffrey:2`` in the fourth virtual window. On the bottom panel, click on ``Observing Tools'' and start MoniCA. 

After selecting the ``Parkes`` site, you can select  the appropriate monitoring GUI from the ``Navigator`` menu. Suggested monitoring items:

*  Navigator -> favourites -> Generators
*  Navigator -> environment -> lightning -> summary_graph  
*  Navigator -> pksobs -> site -> currentalerts

.. tip:: 
   To display multiple panels, click Window -> New window and select the page to display from there.  

Using VNC outside of CSIRO
--------------------------

If necessary, download a VNC client. We recommend TightVNC, which exists for Linux and Windows. Mac users should use Chicken of the VNC.
Establish an ssh tunnel into ATNF for VNC's use, you will need one tunnel for each screen. With two terminals open, type the following: ::

  ssh your_ident@@orion.atnf.csiro.au -L 5901:joffrey.atnf.csiro.au:5901
  ssh your_ident@@orion.atnf.csiro.au -L 5902:joffrey.atnf.csiro.au:5902

Here, *your_ident* is your CASS *nix account (NOT your NEXUS account). This is a requirement for remote observing.

Now, start the VNC Client on your local computer and connect to 127.0.0.1:5901, which is the VNC display for TCS, LOBOSS, etc.

Next, start another VNC Client on your local computer and connect to 127.0.0.1:5902, which is for backends such as DFB3/DFB4 and MoniCA.

If you are unable to connect using the the above AND you are outside the CSIRO network, contact your ISP or home institution.

See "Using VNC from the SOC" about connecting to Pulsar backends such as APSR, BPSR and CASPSR using ssh tunnelling.

Observing Specifics 
--------------------

Below is a detailed "checklist" for you to perform before you start Spectral-line and/or Continuum observations. The checklist is divided into 
sections, based on the application you are required to use.

Conversion System
-----------------

For spectral-line and continuum projects, to set LO attenuation, in any terminal, type ::

  lorun ~/losetup/pXXX.cmd

where "pXXX" is your project code. Check the ~/losetup directory for a full list.

For Pulsar projects, to set LO attenuation, use specific scripts. For example, type ::

  lorun ~/losetup/mb.cmd 

for the 20CM Multibeam receiver, or type ::

  lorun ~/losetup/3100+732.cmd

for the 1050CM receiver. 

Check the ~/losetup directory for a full list. For both cases, to check the attenuators are correctly and press REFRESH on LOGUI. Check C12ATT, 
C30ATT, C40ATT (if using 64/128 MHz BW), and check C50ATT (if using  256 MHz BW). See if these are set to the desired levels as set in the .cmd file.

OPERFCC
-------

With OPERFCC, you can move a receiver on axis. TCS should do this as long as you have the "receiver" key in your schedule file(s). If using atsnap to drive the antenna, you will 
need to place your receiver on focus manually by selecting your receiver and press  "Place selected receiver on axis".

PKMC
----

* ``Focus Cabin Switches -> Camera`` TCS should do this, but on PKMC, turn off all cameras but pressing the "Camera" button to red (off). 
  ``Failure to do this may cause RFI for your observations``. ``TCS`` and ``FROG`` will also alert you if the cameras are still on. See 
  the site.alarms.FCCCams point name under the ``Alarm Manager`` tab.

*  ``Focus Cabin Switches -> Rx`` For all receivers, you should use PKMC to turn your receiver ON/OFF. Click on LNA buttons to turn them GREEN (on) or RED (off)

   .. error:: 
   If the receiver is labeled "Local or not present" instead of "Remote", you will need to contact local staff. Also, if the System Control label 
   is in "Local", contact local staff to place control to "Remote".  

* ``Switch Matrix`` This is usually managed by TCS, no user action required. Some non-standard configurations require a special setup. 
  If so directed by the support staff you will need to run an smrun script from ``joffrey``: smrun ~/smsetup/pXXX.cmd 
  "pXXX" is your project code. Note the filename may be different, check with local operations staff.
  To check whether the Matrix is correctly set, you can check the connections via the Switch Matrix GUI. 

*  ``Cal Control Unit`` If Tsys is to be recorded using DFB4  =>  Set the Calibration signal
        *  Managed by ``TCS`` with CALMODE = SYNC keyword in schedule. CALMODE = OFF disables Tsys measurements.
        *  Click "show" of the "Cal Control Unit"
        *  Turn off all cal signals
        *  Turn on cal signal "row  of your receiver => column BEC-Sync0"
        *  The TCS schedule command "enable becc" enables Tsys logging.
        *  This is a spectral-line / continuum option only.

*  If Frequency switching with DFB3 is to be used  =>  Set the Calibration signal (freq sw):
        *  Must be done manually, TCS cannot set this automatically!
        *  Turn on cal signal "Conv Rack Freq SW => column MBCor FreqSW"
        *  Turn off all undesired cal signals
        *  This is a spectral-line / continuum option only.

*  If frequency-switching with MB20 and MBCor is to be used => Set the Calibration signal:
        *  Must be done manually, TCS cannot set this automatically!
        *  Turn on cal signal "MB FreqSW => MBCor FreqSW"
        *  Turn off all undesired cal signals
        *  This is a spectral-line / continuum option only.

Correlator
----------

*  Spectral-line / continuum projects, check the GUI window title has  "Archive: RPFITS". 
*  Pulsar projects, check the GUI window title has ``Archive: CFITS''.

.. tip::
   IF THE CORRELATOR DOESN'T START, follow the recommended procedures listed in the Troubleshooting section of the 
   `Correlator Guide <http://www.parkes.atnf.csiro.au/observing/documentation/software/CORREL/>`_.

SPD
---

Some basic commands ::

* sel * to see all bandpass data
* sel 11 to see spectra (DFB only)
* sel pp11 to see profiles (DFB only)
* sel aa, bb, cc, dd display Pol A/B, first (aa/bb) and second (cc/dd) IF
* bins 1 - N time-binning mode only: it shows the first N bins of a time-cycle (DFB only)
* x toggle "x" axis:  channels <=> frequencies
* a auto scale amplitude. You can define limits, e.g. a 0 1e3
* ch x-y show only channels from #x to #y. It is usually useful to skip first and lasts channels, e.g. ch 5-8185
* avg|noavg to enable/disable time averaging.
* quit to exit spd.

.. tip::
   Additional commands for SPD can be found `here <http://www.atnf.csiro.au/people/wwilson/spd_linux.html>`_.

DATA
----

On any machine, data is located in directories:
        
*  /nfs/PKCCC4_1   => DFB4 pulsar
*  /nfs/PKCCC4_2   => DFB4 spectral-line/continuum
*  /nfs/PKCCC4_3   => DFB4 pulsar

.. note:: 
   Please restrict data processing to machines ``pictor`` or ``lagavulin``.

Telescope Protection System
---------------------------

The purpose of the Telescope Protection System (TPS) is to only capture issues that would have a major impact if not acted on in a timely manner. 
The TPS is a standalone controller which communicates with systems such as power, weather, vibration monitoring, cryogenics and other equipment. 
These devices are also connected to MoniCA, which the TPS also references. 

Weather and wind restrictions
-----------------------------

With the introduction of the TPS, it will not longer be the responsibility of the observer to concern themselves with monitoring weather conditions, 
only data quality. However, observers should be aware what TPS will do in terms of protecting the antenna in terms of bad weather conditions, which 
are listed below.

Storm Park
----------

The site.alarms.Lightning[0-4] point names under the ``Alarm Manager`` tab in ``FROG`` shows the alarms range from simply indicating (distant) lightning 
has been detected (priority 0-1), through to an alarm indicating you should perhaps consider parking the antenna (priority 3-4). ``FROG`` will sound 
an alert for priority level 2 threats or higher. The observer should acknowledge these alarms and act appropriately, or if appropriate, shelve or 
de-shelve if required (i.e., if there is a false alarm).

For reference, if using Monica, the lightning threat (trigger) levels are (TPS equivalents in brackets):

* No Threat (No threat)
* Distant Lightning (Low threat)
* Some Lightning (Moderate threat) 
* ENABLE GENERATORS (Severe threat)
* STORM PARK (Severe threat)

A lightning threat level of moderate (or greater) triggers the Generator automatic start point in Monica, causing the TPS to start the generator and 
run for at least 15 minutes. If after 15 minutes, the lightning threat level is less than moderate the generator will stop and power will revert to 
mains (if available), otherwise it will run for further 15 minutes and so on. 

If the threat level is moderate and there is no generator ``OR`` the level is severe, the generator will follow the same procedure above, but the 
antenna will also be stowed.

Automated Wind Park
-------------------

The ``SERVO``  computer monitors the speed and direction of the wind from the paddock sensor, and will stow the dish automatically above limits 
(defined in the table below) to ensure the safety of the antenna. Winds can be monitored with ``FROG``.

================== ===== ==== =======
\                  Peak2 Gust Average
================== ===== ==== =======
Ane #1 (Az front)  58    54   42
Ane #1 (Az front)  58    54   42
Ane #1 (Az back)   46    42   35
Ane #2 (Az front)  66    62   48
Ane #2 (Az back)   53    48   40
================== ===== ==== =======

During an automated wind park, the antenna drives to an Azimuth that has the wind at least 60-degrees away from the back of the dish without 
driving into an Azimuth limit.  If you are observing near one of the limits and there is an easterly wind this could involve driving up to 100 
or so degrees. In addition, the antenna will drive to a (software limit) Zenith angle of 1.2 degrees.

.. important::
   If the wind is particualry high, the antenna can be driven into the Zenith hardware limit past 1.2 degrees.
   You will need to exit the limit by stowing and then unstow the antenna using the "Unstow - ExLim" button on TCS. 

The Peak (2 consecutive readings), Gust (5 readings in the last 180), and  Average (15 readings in the last 20) values (in km/hr) must be
satisfied for a wind park to occur. The ``Az back'' for each Anemometer are for winds within Azimuths 150 degrees < Az < 210 degrees (ie, 
winds within 30 degrees of the back of the antenna). The ``Az front'' values are for the remaining 300 degrees ``front-on''sector.
A wind park holds the antenna at the software limit (Ze ~ 1.2 deg.) limit for 10 minutes until the countdown expires. At the end of this period 
the antenna is free to obey any pending or new commands.

There is also a "wind park mode" in TCS which is relevant only when using the DFBs in pulsar search mode. If enabled, TCS will attempt to complete 
a DFB search mode observation even if the antenna stops tracking due to a wind park, power failure, or manual override from the MCP; this preserves 
the continuity of the time series). If the antenna becomes available before the observation has completed TCS will command it to return to the 
target position.

.. warning:: 
   Once an automatic wind park has occurred, the antenna must not be moved until permissible conditions have prevailed for at 
   least 10 minutes. If conditions are poor, the antenna must be fully stowed.

Current Park
------------

The wind has a greater effect on the Zenith motor currents of the dish at high Zenith angles and if it is directed either towards the
surface or the back of the dish. The main problem is that a strong wind onto the back of the dish can "hold it down" causing
the motor currents to reverse (the counter weight is heavier than the dish). In this case, you might receive a 'HIGH/LO Current Stow'. 
In a physical sense, the low current condition is intended to detect overbalancing of the antenna
when a strong wind blows into the back of the dish. The threshold for the low current condition is three occurances in 120 seconds
where the magnitude between the Zenith motor currents is greater than 30 Amps. For the high current condition to be triggered, the sum of the Zenith 
currents must be less than -5 Amps for more than three seconds in the last 120 seconds where the antenna not slewiing upwards.

Once parked, you are required to wait at least 10 minutes to see if the conditions allow for observing to resume. Typically this
is true if the ``peak wind is below 40 km/s``, but it depends on the elevation of your source.

Power Supply
------------

The Observatory has two sources of power. The principal power supply is provided from a recently
installed (Dec 2012) 750kVA transformer, regulator and switchgear equipment. A 300kV diesel generator 
provides a backup supply to most circuits in the tower (and some elsewhere on site) in the event of 
mains failure. Some critical circuits have a further backup from an Uninterruptible Power Supply (UPS) 
which can last up to 1 hour, supplying ctitical systems. Computers, electronics, clocks, masers and 
receiver systems are connected to the UPS protected circuits. There is also a drive UPS, which is used 
to stow the antenna in the event of various triggers determined by the TPS.

If the Country Energy mains fail, the generator should start automatically and provide power 
so that after a short interruption you will be able to resume observing.  If the generator 
fails to start and the mains supply does not return, a timer will initiate and if it reaches 
two (2) minutes, the TPS will automatically stow the antenna using the drive UPS.

You can monitor the Mains and GenSet with `Monica <http://www.narrabri.atnf.csiro.au/open-monica/OpenMoniCA.JNLP>`_.
Click on Parkes - Navigator - favourites - generators. Monica should be running on the fourth virtual desktop of 
the VNC server, ``joffrey:1`` (you can install MoniCA using the link above). The likely scenarios are dealt with separately below.

Power failure - Brief mains glitch
----------------------------------

In this situation, due to the drive UPS, the MCP and the Azimuth and Zenith 
drives will not disable. The MCP remains under computer control.  If the dish 
is still in lock capture range of the ME the antenna will reacquire lock and 
the drive can resume. On the MoniCA display, you should see the following:

*  LS4 - Mains power available : true
*  GPC31 - Generator start enabled : false

Power failure - Generator starts automatically
----------------------------------------------

If there is a failure of the mains for longer than a second, the generator should start automatically.  Once it is up to speed it will be switched to 
supply the antenna. As the MCP is connected to the Drive UPS, the Azimuth and Zenith drives should still be enabled. On the Monica display display, 
you should see the following:

*  LS4 - Mains power available : false
*  GPC31 - Generator start enabled : true

If both of these items are false, proceed as described in "Severe Power Failure - no mains or generator".

Severe Power Failure - no mains or generator
--------------------------------------------

When the mains power is available again, and has been stable for a period of around 1 minute, the suppy will automatically revert
from generator to mains. The MCP will remain on and because the generator synchronises with the mains on transfer back to mains power, it happens 
without a break, so the UPS suffers no break in input power.  

Severe Power Failure - no mains or generator
--------------------------------------------

The TPS continuously checks to see if there is power, whether it be from the mains or site generator. If the TPS does not receive an acknowlegement 
that there is power, from the mains OR the generator, the TPS will automatically stow the antenna using the drive UPS.
